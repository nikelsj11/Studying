##Отчет по лабораторной работе №4
&nbsp; | &nbsp;
 --------------------- | ---------------------------------- 
**Предмет**            | *Методы интеллектуального поиска*   
**Выполнил**           | *Красюк Никита*                    
**Группа**             | *НК-401*                           
**Студенческий билет** | *103111130*  
                      
---------------------------------------------------------------------
### Постановка задачи
Реализовать программу морфологического анализа текста.
Программа считывает из морфологического словаря, находящегося в файле, множество лексем и их парадигматических форм с морфологическими признаками и организует их в подходящую структуру данных.
Программа получает на вход в качестве параметра имя файла, в котором находится текст для морфологического разбора. Программа считывает текст и выполняет его токенизацию (аналогично лаб. №1). Затем для всех токенов осуществляется проверка наличия словоформ в словаре. В выходной файл с именем ```“<имя_входного_файла>.out”``` печатается:  
```
Порядковый № токена) исходная словоформа в тексте [словарная форма 1 / морфологические признаки словоформы], [словарная форма 2 / морфологические признаки словоформы]...
```  
Информация о каждом токене печатается с новой строки. Если какая либо словоформа омонимична (существует несколько вариантов нормализации или несколько подходящих наборов признаков), то они печатаются все друг за другом в этой же строке. Для токенов, словоформы которых не обнаружены в словаре, выдавать “- NOT FOUND” вместо морфологических признаков и нормальной формы.
Дополнительно выдавать статистику:  
 1. Общее количество токенов  
 2. Количество токенов-пунктуации.  
 3. Количество токенов-словоупотреблений (не считая пунктуацию).  
 4. Количество токенов-словоупотреблений, для которых не найдены признаки в словаре.  
 5. Количество токенов-словоупотреблений, для которых найдено более 1 варианта нормализации или более 1 набора признаков (омонимичные токены).  
 6. Среднее количество омонимов из расчёта на 1 токен-словоупотребление.

---------------------------------------------------------------------
### Подготовка данных

Исходный словарь в текстовом виде весит целых 326 мб:  
```
home-work > ll -h speakrus.dict.ignore 
-rw-rw-r-- 1 nkrasyuk nkrasyuk 326M Oct 12  2014 speakrus.dict.ignore
```
Учитывая эту делать, загружать его целиком в память, обернув при этом в нужные структуры данных, будет плохой идеей + немаловажно, что при каждом запуске придется повторять этот процесс. В качестве инструмента для хранения и получения данных из словаря я решил применить MongoDB.  
Для этих целей я написал скрипт **dict_to_mongo.py** который конвертирует словарь в набор записей в базе данных. Продемонстрирую на конкретном примере.  

Допустим у нас есть следующий фрагмент словаря(файл **raw_files/test.dict**):  
```
абака | сущ неод ед жен им | 144753
  абаки | сущ неод ед жен род | 312978
  абаке | сущ неод ед жен дат | 312979
  абаку | сущ неод ед жен вин | 312980
  абакою | сущ неод ед жен тв | 312983
  абакой | сущ неод ед жен тв | 312981
  абаке | сущ неод ед жен пр | 312982
абаки | сущ неод мн им | 4144167
  абак | сущ неод мн род | 4144168
  абакам | сущ неод мн дат | 4144169
  абаки | сущ неод мн вин | 4144172
  абаками | сущ неод мн тв | 4144170
  абаках | сущ неод мн пр | 4144171

*якающие | прл мн им | 1023417
  *якающих | прл мн род | 1023418
  *якающим | прл мн дат | 1023419
  *якающие | прл мн вин неод | 1023420
  *якающих | прл мн вин одуш | 1023423
  *якающими | прл мн тв | 1023421
  *якающих | прл мн пр | 1023422
```
Запускаем:   
```bash
home-work > dict_to_mongo.py raw_files/test.dict 
[============================================================] 100.0% ... 20 / 20 
Done.
```
В результате получим данные в следующем виде:  
```bash
home-work > mongo
MongoDB shell version: 2.2.4
connecting to: test
> db.test.find()
{ "_id" : 144753, "is_archaic" : false, "word" : "абака", "details" : "сущ неод ед жен им" }
{ "_id" : 312978, "prior" : 144753, "is_archaic" : false, "word" : "абаки", "details" : "сущ неод ед жен род" }
{ "_id" : 312979, "prior" : 144753, "is_archaic" : false, "word" : "абаке", "details" : "сущ неод ед жен дат" }
{ "_id" : 312980, "prior" : 144753, "is_archaic" : false, "word" : "абаку", "details" : "сущ неод ед жен вин" }
{ "_id" : 312983, "prior" : 144753, "is_archaic" : false, "word" : "абакою", "details" : "сущ неод ед жен тв" }
{ "_id" : 312981, "prior" : 144753, "is_archaic" : false, "word" : "абакой", "details" : "сущ неод ед жен тв" }
{ "_id" : 312982, "prior" : 144753, "is_archaic" : false, "word" : "абаке", "details" : "сущ неод ед жен пр" }
{ "_id" : 4144167, "is_archaic" : false, "word" : "абаки", "details" : "сущ неод мн им" }
{ "_id" : 4144168, "prior" : 4144167, "is_archaic" : false, "word" : "абак", "details" : "сущ неод мн род" }
{ "_id" : 4144169, "prior" : 4144167, "is_archaic" : false, "word" : "абакам", "details" : "сущ неод мн дат" }
{ "_id" : 4144172, "prior" : 4144167, "is_archaic" : false, "word" : "абаки", "details" : "сущ неод мн вин" }
{ "_id" : 4144170, "prior" : 4144167, "is_archaic" : false, "word" : "абаками", "details" : "сущ неод мн тв" }
{ "_id" : 4144171, "prior" : 4144167, "is_archaic" : false, "word" : "абаках", "details" : "сущ неод мн пр" }
{ "_id" : 1023417, "is_archaic" : true, "word" : "якающие", "details" : "прл мн им" }
{ "_id" : 1023418, "prior" : 1023417, "is_archaic" : true, "word" : "якающих", "details" : "прл мн род" }
{ "_id" : 1023419, "prior" : 1023417, "is_archaic" : true, "word" : "якающим", "details" : "прл мн дат" }
{ "_id" : 1023420, "prior" : 1023417, "is_archaic" : true, "word" : "якающие", "details" : "прл мн вин неод" }
{ "_id" : 1023423, "prior" : 1023417, "is_archaic" : true, "word" : "якающих", "details" : "прл мн вин одуш" }
{ "_id" : 1023421, "prior" : 1023417, "is_archaic" : true, "word" : "якающими", "details" : "прл мн тв" }
{ "_id" : 1023422, "prior" : 1023417, "is_archaic" : true, "word" : "якающих", "details" : "прл мн пр" }
```
Как видно структура получилась достаточно простая:
 - Каждая запись это одна конкретная словоформа с набором характеристик и id.  
 - Некоторые словоформы имеют поле *prior* в котором содержится id подчиняющей словоформы.  
Также была проведена индексация полей по которым будет осуществляться поиск *_id* и *word*:
```js
> db.test.getIndexes()
[
	{
		"v" : 1,
		"key" : {
			"_id" : 1
		},
		"ns" : "test.test",
		"name" : "_id_"
	},
	{
		"v" : 1,
		"key" : {
			"word" : 1
		},
		"ns" : "test.test",
		"name" : "word_1"
	}
]
```
Теперь проведем загрузку исходного словаря:  
```bash
home-work > python dict_to_mongo.py raw_files/speakrus.dict.ignore 
[============================================================] 100.0% ...4302072 / 4302072 
Done.
```
Данные были загружены в следующую бд и коллекцию (файл **_dist.py**):  
```python2.7
DB_NAME = 'morph-dicts'
DB_COLLECTION = 'speakrus'
```
Проверим количество записей:  
```js
> db.speakrus.count()
4159394
```
Что полностью соответствует информации из описания словаря:  
```
Словарь содержит  4 159 394 словоформ для 142 792  лемм.
```
Сделаем несколько запросов:  
```js
> db.speakrus.find({word: "мама"})
{ "_id" : 9557, "is_archaic" : false, "word" : "мама", "details" : "сущ одуш ед жен им" }
> db.speakrus.find({word: "мыла"})
{ "_id" : 425963, "prior" : 170154, "is_archaic" : false, "word" : "мыла", "details" : "сущ неод ед ср род" }
{ "_id" : 1533761, "is_archaic" : false, "word" : "мыла", "details" : "сущ неод мн им" }
{ "_id" : 1533764, "prior" : 1533761, "is_archaic" : false, "word" : "мыла", "details" : "сущ неод мн вин" }
{ "_id" : 78129, "prior" : 78128, "is_archaic" : false, "word" : "мыла", "details" : "гл несов перех прош ед жен" }
> db.speakrus.find({word: "раму"})
{ "_id" : 16656, "prior" : 16653, "is_archaic" : false, "word" : "раму", "details" : "сущ неод ед жен вин" }
> db.speakrus.find({word: "грыполутрамоном"})
>
```

---------------------------------------------------------------------
### Ход решения

Алгоритм достаточно простой:
 * Открываем для записи входной файл
 	* Открываем файл для вывода
 		* Итерируем входной файл по строкам
 			* Токенизация каждой строки
 			* Итерируем по токенам
 				* Получаем информацию по каждому токену
 				* Записываем информацию по каждому токену в файл для записи
 				* Считаем статистику 

На каждом токене посылается запрос в базу данных, для каждого найденного токена, имеющего поле **prior** посылается еще один вопрос для получения формы нормализации. Скрипт **morphological_analyzer.py**.

---------------------------------------------------------------------
### Результаты

Итоги данной лабораторной работы лучше демонстрировать на конкретных результатах. Для начала разберем пример из текста задания, пример срдержится в файле **raw_files/test.group**:  
```bash
home-work > cat raw_files/test.group
1) Мама мыла раму грыполутрамоном.home-work
```
Запускаем:
```bash
home-work > python morphological_analyzer.py raw_files/test.group raw_files/test.group.out 
[============================================================] 100.0% ... 1 / 1 
Done.
```
Результат (файл raw_files/test.group.out):  

```bash
home-work > cat raw_files/test.group.out
1                    1                    NOT FOUND
2                    )                    PUNCTUATION
3                    Мама                 [мама / сущ одуш ед жен им / 9557] 
4                    мыла                 [мыла / сущ неод мн им / 1533761] [мыло / сущ неод ед ср им / 170154] [мыла / сущ неод мн им / 1533761] [мыл / гл несов перех прош ед муж / 78128] 
5                    раму                 [рама / сущ неод ед жен им / 16653] 
6                    грыполутрамоном      NOT FOUND
7                    .                    PUNCTUATION

CТАТИСТИКА:
    1: Общее количество токенов: 7.
    2: Количество токенов-пунктуации: 5.
    3: Количество токенов-словоупотреблений (не считая пунктуацию) : 2.
    4: Количество токенов-словоупотреблений, для которых не найдены признаки в словаре: 2.
    5: Количество токенов-словоупотреблений, для которых найдено более 1 варианта
                        нормализации или более 1 набора признаков (омонимичные токены): 1.
    6: Среднее количество омонимов из расчёта на 1 токен-словоупотребление
                                            (только для найденных в словаре словоформ): 2.
```
*Токены из для слова "мыла" немного не соответствуют тем что в примере, но я проверял вручную все верно.*  
Теперь проделаем теже действия с Войной и Миром. Для этого я скачал первый попавшийся экземпляр данного произведения, перенонвертировал его в кодировку utf-8, (файл **raw_files/War_and_Peace.txt**):  
```bash
home-work > recode CP1251..UTF8 War_and_Peace.txt
```
И запустил процесс обработки:  
```bash
home-work > python morphological_analyzer.py raw_files/War_and_Peace.txt raw_files/War_and_Peace.txt.out 
[============================================================] 100.0% ... 47342 / 47343 
Done.
```
Полученный результат (файл **raw_files/War_and_Peace.txt.out**):
```bash
home-work > cat raw_files/War_and_Peace.txt.out | head -n 10000 | tail -n 20
9981                 то                   [то / мест прил ед ср им / 4013808] [то / мест сущ ед ср им / 4154683] [то / союз / 207306] [то / част / 165232] [то / мест сущ ед ср им / 4154683] [то / мест прил ед ср им / 4013808] 
9982                 же                   [же / част / 207468] [же / союз / 207124] 
9983                 выражение            [выражение / сущ неод ед ср им / 38033] [выражение / сущ неод ед ср им / 38033] 
9984                 ,                    PUNCTUATION
9985                 какое                [какое / мест прил ед ср им / 4014896] [какое / част / 207504] [какое / мест прил ед ср им / 4014896] 
9986                 оно                  [оно / част / 4254849] [оно / мест сущ ед ср им / 46373] 
9987                 имело                [имел / гл несов перех прош ед муж / 76475] 
9988                 в                    [в / предл им / 4127933] [в / предл вин / 4127892] [в / предл пр / 4127891] 
9989                 гостиной             [гостиная / сущ неод ед жен им / 147188] [гостиная / сущ неод ед жен им / 147188] [гостиная / сущ неод ед жен им / 147188] [гостиная / сущ неод ед жен им / 147188] [гостиная / прл ед жен им / 647401] [гостиная / прл ед жен им / 647401] [гостиная / прл ед жен им / 647401] [гостиная / прл ед жен им / 647401] 
9990                 Анны                 [анны / сущ неод мн им / 4144245] [анна / сущ неод ед жен им / 4084812] [анны / сущ неод мн им / 4144245] 
9991                 Павловны             NOT FOUND
9992                 .                    PUNCTUATION
9993                 Пьер                 NOT FOUND
9994                 спустил              [спустил / гл сов пер/не прош ед муж / 96178] 
9995                 ноги                 [ноги / сущ неод мн им / 1448526] [нога / сущ неод ед жен им / 12083] [ноги / сущ неод мн им / 1448526] 
9996                 с                    [с / предл вин / 4127928] [с / предл род / 4127927] [с / предл тв / 4127926] 
9997                 дивана               [диван / сущ неод ед муж им / 24921] 
9998                 .                    PUNCTUATION
9999                 Вошла                [вошел / гл сов непер прош ед муж / 1619847] 
10000                княгиня              [княгиня / сущ одуш ед жен им / 7727] 
```
И статистика в конце файла:
```bash
CТАТИСТИКА:
    1: Общее количество токенов: 591344.
    2: Количество токенов-пунктуации: 463303.
    3: Количество токенов-словоупотреблений (не считая пунктуацию) : 128041.
    4: Количество токенов-словоупотреблений, для которых не найдены признаки в словаре: 39595.
    5: Количество токенов-словоупотреблений, для которых найдено более 1 варианта
                        нормализации или более 1 набора признаков (омонимичные токены): 277283.
    6: Среднее количество омонимов из расчёта на 1 токен-словоупотребление
                                            (только для найденных в словаре словоформ): 2.
```
