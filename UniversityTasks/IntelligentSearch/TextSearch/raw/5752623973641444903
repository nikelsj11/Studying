#TITLE:Поиск периодических элементов защиты Паспорта РФ с помощью преобразования Фурье: часть вторая

      Многие документы содержат защитные элементы, такие как голограммы, водяные знаки, гильош и т.д. В процессе сканирования таких документов возникает проблема — защитные элементы мешают системам распознавания (OCR). При разработке Smart PassportReader мы провели исследование, направленное на поиск и устранение подобных защитных элементов с изображений документов.
В нашей предыдущей статье по этой теме мы рассказали о первой половине решения задачи поиска — детектировании, т.е. определении наличия периодических элементов на изображении. Сегодня мы расскажем, как найти непосредственное положение периодических элементов на изображении, при условии, что детектирование прошло успешно: мы уверены, что элементы на изображении присутствуют. Вторая часть сильно зависит от первой, поэтому настоятельно рекомендуется сначала ознакомиться с первой, если вы этого еще не сделали.
Как и в прошлый раз, для этого будет использоваться преобразование Фурье.Модель изображения
Как и в прошлый раз, многие рассуждения будут показаны для одномерного случая, который потом легко переносится на двумерный.
Напомним, что  — исходное изображение длины , состоящее из двух других: фонового изображения  и изображения , содержащего периодический шаблон. Изображение , в свою очередь, мы представили сверткой (convolution) одного экземпляра шаблона  с гребнем Дирака :
Так как нам заранее известна структура периодического шаблона (в случае паспорта РФ — размер и период голограмм), для восстановления положения элементов достаточно знать только сдвиг всего шаблона по горизонтали и вертикали, что есть то же самое, что сдвиг одного из “орлов”.Дискретное преобразование Фурье от сдвинутого периодического шаблона
Сдвиг сигнала паттерна  равносилен сдвигу импульсной функции , который приводит к измененной форме . Спектр преобразования Фурье сдвинутого сигнала изменяется только в фазе, оставляя неизменной амплитуду, позволяя, тем самым детектировать периодические паттерны вне независимости от их начального сдвига. Как важное следствие, вся полезная фазовая информация сосредоточена в тех же самых ДПФ позициях (частотах), что и пики амплитуды импульсного сигнала.
Предположим, что  сдвинут вправо на , тогда:
Поскольку фазовый угол  для несмещенного  равен нулю, для смещенного  он становится равным . Для получения фазового сдвига  нам необходимо добавить каждый член  к соответствующему фазовому углу в  для каждого . Заметим, что любой фазовый угол всегда берется по модулю  и ограничивается интервалом .
Фазовый сдвиг на  в частотной области представляет сдвиг  во временной области, но  имеет период , поэтому мы может избежать избыточности рассмотрением лишь , обеспечив таким образом . Для удобства, пусть  – это фазовый сдвиг, у которого  соответствует временному сдвигу на , а также пусть  – это фазовый угол на 'ом амплитудном пике:
На рисунке показан пример ДПФ фазы сдвинутого импульсного сигнала с значениями , периодом  и сдвигом . Например,  и .
А вот так выглядит амплитуда и фаза ДПФ для похожей на шахматную доску сетки Гауссиан: — ДПФ --&gt; 
Для двумерного изображения, фазовый сдвиг  теперь состоит из двух компонент . Введем координатную сетку для ДПФ шахматоподобной системы пиков, показанных на втором и третьем рисунках выше, такую, что центральный пик имеет координаты , пики справа вверху ,  и так далее; ближайший диагональный пик имеет координаты . В общем случае, пик  присутствует тогда и только тогда, когда  – четно.
Применяя вновь теорему о ДПФ сдвинутого сигнала, можно расширить уравнение сдвига и показать, что фазовый угол  на  пике для двумерного импульсного сигнала равен:
Как и для одномерного случая, для получения сдвинутой фазы  необходимо добавить  к соответствующей фазе .Поиск периодического шаблона
Для определения точного местоположения периодического паттерна достаточно оценить его фазовый сдвиг , поскольку его пиксельная периодическая структура заранее известна. Пиксельный сдвиг , впоследствии, нетрудно восстановить по информации о фазовом сдвиге.Вырезание, масштабирование и предобработка изображения
В первой статье мы описали различные стадии предобработки исходного изображения паспорта. Сначала из изображения вырезается зона, содержащая 2х2 решетку (подобную шахматной доске) и содержащая 2 шаблона по горизонтали и вертикали. Это может быть сделано (с ошибкой менее с 5%), поскольку физические размеры документа, размеры и период периодических шаблонов фиксированы и известны заранее. Положение региона может быть установлено комбинированием физических координат документа с его координатами на изображении.
Далее производится существенное сжатие и сглаживание изображения для подавления фона и нивелирования различий между периодическими паттернами. Рисунок ниже показывает изображение вырезанного региона Российского паспорта, результаты его предобработки и амплитуду его ДПФ. — обработка --&gt;  — ДПФ --&gt; 
Как и ожидалось, амплитуда ДПФ имеет заметные пики с распределением, похожим на шахматную доску.Предобработка спектра
В соответствии с моделью изображения, исходное изображение состоит из трех независимых сигналов: фонового изображения  и единичного образца периодического паттерна , который свертывается со сдвинутым импульсным сигналом , чтобы получить периодический паттерн :
После выполнения ДПФ на , мы имеем:<img src="http://tex.s2cms.ru/svg/%5Clabel%7Beq%3Aimmodel_dft_base%7D%0A%20%20%5Cmathcal%7BF%7D%20I(x)%20%3D%20%5Cmathcal%7BF%7D%20h(x)%20%2B%20%5Cmathcal%7BF%7D%20f(x)%20%5Ccdot%20%5Cmathcal%7BF%7D%20c(x)%0A" alt="\label{eq:immodel_dft_base}
  \mathcal{F} I(x) = \mathcal{F} h(x) + \mathcal{F} f(x) \cdot \mathcal{F} c(x)">
Для получения сдвига фаз , хранящегося в , из , которое мы вычислили для данного изображения, нам необходимо постепенно подавить остальные компоненты уравнения.Подавление спектра фона
Если фон  после препроцессинга достаточно однороден на обрабатываемых документах, возможно простое вычисление усредненного спектра  на изображениях документов, на которых отсутствует искомый периодический паттерн, с последующим его вычитанием из .
Однако, фоновое изображение  в нашей модели фактически не является фоном в терминах структуры Российского паспорта: оно содержит персональные данные, которые по определению различаются на обрабатываемом наборе.
Ранее мы уже упоминали тот факт, что ДПФ позиции (частоты) без пиков не содержат полезной информации касательно периодических паттернов, поскольку они представляют фон. Предположив, что  является гладким, мы можем интерполировать его вклад в каждый пик , основываясь на значениях в соседних с пиком позициях. Усредненное значение  по  по ближайшим соседям пика  в 3x3 окне является приемлемой оценкой  для вычитания из , чтобы вычистить фон:
Следующий рисунок содержит сжатое изображение и изображение, полученное в результате обратного ДПФ после вычитания интерполированного спектра фона и обнуления ДПФ на всех непиковых частотах. — ДПФ, вычитание спектра фона, обратное ДПФ ----&gt; 
Как и ожидалось, только периодический паттерн остался на простом монотонном фоне и экземпляры периодическиого паттерна стали более похожими друг на друга. Отметим, что фон не является черным, поскольку значение ДПФ на , которое содержит усредненное по изображению значение, не было обнулено.Подавление спектра экземпляров паттерна
После удаления фонового спектра у нас осталось . При перемножении двух комплексных чисел, их фазы складываются. Тогда, для достижения фазового угла  у пика , соответствующий фазовый угол спектра единичного экземпляра периодического паттерна  должен быть вычтен.
Проблема состоит в том, что спектр периодического паттерна, как правило, неизвестен. Одним из возможных решений является экспериментальное вычисление фазы представленного образца паттерна и его последующее вычитание. В наших экспериментах мы использовали другой путь, предполагая, что фазовый вклад  постоянен, значит, к результирующему сдвигу  добавляется еще один константный сдвиг. Эта сдвиговая константа может быть оценена экспериментально как систематическая ошибка на тестовом наборе данных.Восстановление фазового сдвига
По окончании предобработки спектра мы имеем фазовый угол импульсного сигнала , который предположительно содержит всю необходимую информацию про фазовый сдвиг .
Мы можем построить систему уравнений (каждое уравнение соответствует  пику) по модулю :<img src="http://tex.s2cms.ru/svg/%0A%20%20%5Cbegin%7Bcases%7D%0A%20%20%20%20%5Cdots%20%5C%5C%0A%20%20%20%20i%5Ccdot%5Cphi_x%20%2B%20j%5Ccdot%5Cphi_y%20%3D%20%5Cphi_%7Bi%2C%20j%7D%20%5Cpmod%7B2%5Cpi%7D%20%5C%5C%0A%20%20%20%20%5Cdots%20%5C%5C%0A%20%20%5Cend%7Bcases%7D%0A" alt="\begin{cases}
    \dots \\
    i\cdot\phi_x + j\cdot\phi_y = \phi_{i, j} \pmod{2\pi} \\
    \dots \\
  \end{cases}">
Или, в матричной форме:
В левой части системы содержатся «идеальные» значения фазы, соответствующие пикам, а в правой — актуальные значение фазы ДПФ для данного изображения в позициях пиков.
Эта система переопределена, т.к. она имеет  уравнений (по числу рассматриваемых пиков) и только 2 переменные:  и . Переопределенные системы уравнений могут быть приближенно решены методом наименьших квадратов (МНК) поиском решения, минимизирующего сумму квадратов невязок. Однако, эта система является системой по модулю  поэтому напрямую МНК не может быть применен, но мы можем вычислить начальное решение и скорректировать его последовательным решением системы.Вычисление начального решения
Посмотрим на два уравнения для пиков под номерами  и :<img src="http://tex.s2cms.ru/svg/%0A%20%20%5Cbegin%7Bcases%7D%0A%20%20%20%202%5Ccdot%5Cphi_x%20%2B%200%5Ccdot%5Cphi_y%20%3D%20%5Cphi_%7B2%2C%200%7D%20%5Cpmod%7B2%5Cpi%7D%20%5C%5C%0A%20%20%20%200%5Ccdot%5Cphi_x%20%2B%202%5Ccdot%5Cphi_y%20%3D%20%5Cphi_%7B0%2C%202%7D%20%5Cpmod%7B2%5Cpi%7D%0A%20%20%5Cend%7Bcases%7D%0A" alt="\begin{cases}
    2\cdot\phi_x + 0\cdot\phi_y = \phi_{2, 0} \pmod{2\pi} \\
    0\cdot\phi_x + 2\cdot\phi_y = \phi_{0, 2} \pmod{2\pi}
  \end{cases}">
Эта система имеет 4 допустимых решения: , ,  и . Из-за подобной шахматной доске структуры пиковых паттернов в нашем случае, а также, поскольку  представляет собой сдвиг на единичный период, первое с четвертым решения идентичны, как и второе с третьим. Остается два потенциальных решения:  и .
Для выбора правильного решения мы можем добавить к системе два оставшихся уравнения для пиков  и , вновь сделав систему переопределенной. Тогда, значение невязки  вычисляется для -го решения  с учетом всех  уравнений:<img src="http://tex.s2cms.ru/svg/%20%5Cdelta_k%20%3D%20%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi%2C%20j%7D%7B%5Cleft(%5Cbegin%7Bpmatrix%7Di%20%26%20j%5Cend%7Bpmatrix%7D%20%5Ccdot%5Cphi%5E*_k%20-%20%5Cphi_%7Bi%2C%20j%7D%5Cright)%5E2%7D%0A%20%20%20%20%20%20%20%20%20%20%20%3D%20%5Cfrac%7B1%7D%7Bn%7D%7CA%5Cphi%5E*_k-b%7C%5E2%20" alt="\delta_k = \frac{1}{n}\sum_{i, j}{\left(\begin{pmatrix}i &amp;amp; j\end{pmatrix} \cdot\phi^*_k - \phi_{i, j}\right)^2}
           = \frac{1}{n}|A\phi^*_k-b|^2">
Отметим, что промежуточные вычисления, затрагивающие фазовые углы (вычисление разностей), выполняются в .
Наконец, решение , имеющее наименьшее значение  выбирается в качестве , поскольку другое решение будет иметь намного большее значения невязки. Большое значение  для  может означать ложное обнаружение пика.Корректировка решения
Найденное выше начальное решение могло бы быть хорошим, если бы оставшийся спектр содержал только информацию про  и ничего более. К сожалению, он искажен спектральными составляющими от фона и от образцов периодических паттернов, которые не были полностью удалены во время предобработки.
На данном этапе выбранное решение  является все еще верным, но может быть уточнено с использованием фазовой информации в других пиках, а не только по двум первым. Вычтем  (используя  уравнения) из обоих частей системы уравнений, сдвинув таким образом пространство решений по  и получив следующую переопределенную систему уравнений для корректирующего решения :<img src="http://tex.s2cms.ru/svg/%5Clabel%7Beq%3Acorrection_phase%7D%0A%20%20A%5Ctheta%20%3D%20b%20-%20A%5Cphi%5E*%0A" alt="\label{eq:correction_phase}
  A\theta = b - A\phi^*">
Предполагая, что в первом приближении решения мы ошиблись не больше, чем на , мы можем не брать систему по модулю , т.к. после сдвига системы каждое уравнение будет внутри , что означает, что мы может приближенно решить систему, используя метод наименьших квадратов. После того, как решение  найдено, оно должно быть добавлено к ранее найденному начальному решению  в качестве корректирующего значения.
До сих пор мы рассматривали уравнения для первых 4 пиков  имеющих  сумму равную 2 (и  из-за симметричности ДПФ), но ведь существуют другие пики с суммами, равными 4, 6 и так далее. Причина, почему они не были добавлены ранее, состоит в том, что при увеличении  увеличивается и количество подходящих решений системы, и тем ближе они становятся друг к другу по модулю .
Для использования информации о фазовом сдвиге, содержащейся в остальных пиках, мы можем повторить вышеописанный процесс корректировки начального решения, заменив  скорректированным решением, полученным для суммы, равной 4 и используя все уравнения, имеющие сумму, равную 6 и так далее, до достижения требуемой точности. Предполагая, что с увеличением итерации ошибка уменьшается, каждое уравнение будет находиться в пределах , что позволяет применять МНК для решения системы.Восстановление расположения периодических паттернов
Теперь, имея фазовый сдвиг , мы можем легко преобразовать его обратно в пиксельный сдвиг . Зная период и размер паттернов, мы можем восстановить положение каждого паттерна решетки. Размер и положение вырезанного региона, который мы использовали в процессе обработки, также известны, поэтому мы можем получить позиции паттернов на исходном изображении документа.
Следующий рисунок, который вы уже видели в самом начале статьи, представляет пример нахождения голографического периодического шаблона на российском паспорте.
Рамкой с кружком внутри обозначен результат, найденный после решения системы уравнений. Другими рамками обозначены экстраполированные позиции остальных паттернов.Экспериментальные результаты
Мы использовали набор данных из 484 изображений отсканированных российских паспортов, имеющих голографическое заполнение. Для каждого изображения в наборе мы подготовили истиное значение пиксельного сдвига его периодического паттерна. Таблица ниже содержит экспериментальные результаты для этого набора данных с усредненным значением невязки смещения как меры точности.
Ошибка задана в процентах от стороны единичного паттерна. Предобработка состояла из сжатия к размеру 56x58 и морфологической операции замыкания; при решении системы для получения фазового сдвига были рассмотрены  уравнений пиков.Подавление фона 
 Корректировка с МНК 
 x ошибка 
 y ошибка 
 Общая ошибка
Отсутствует 
 Отсутствует 
 2.13 
 6.40 
 6.75 
Присутствует 
 Отсутствует 
 2.09 
 6.04 
 6.40 
Отсутствует 
 Присутствует 
 2.19 
 5.05 
 5.50 
Присутствует 
 Присутствует 
 2.20 
 4.77 
 5.25 

Следующий рисунок показывает распределение  и  ошибок для худшего (слева) и лучшего (справа) метода. Черные ячейки представляют ошибку по , а белые – по .
На этих гистограммах ось Y обозначает, сколько процентов изображений (из 484) имеет ошибку, близкую к соответствующему значению по оси X (в процентах от размера стороны периодического паттерна). Видно, что распределение  ошибки для лучшего метода менее разбросано, чем для худшего.Заключение
Мы предложили метод поиска периодических шаблонов на изображениях документов, который использует дискретное преобразование Фурье и показал среднюю ошибку поиска в  (от стороны периодического элемента) на наборе из 484 изображений.
О подробностях применения нами этого метода мы расскажем в одной из следующих статей.

      
      
    